name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # Job 1: è¿è¡Œæµ‹è¯•
  test:
    name: Run Tests
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ç”¨äºç”Ÿæˆ changelog

      - name: Setup .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --no-restore -c Release

      - name: Run tests
        run: dotnet test --no-build -c Release --verbosity normal

  # Job 2: æ„å»ºå’Œå‘å¸ƒï¼ˆä¾èµ–æµ‹è¯•æˆåŠŸï¼‰
  build-and-release:
    name: Build and Release
    runs-on: windows-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ç”¨äºç”Ÿæˆ changelog

      - name: Setup .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x

      - name: Restore Dependencies
        run: dotnet restore ./RimTransAI/RimTransAI.csproj

      - name: Get Tag Version
        id: version
        shell: pwsh
        run: |
          # ä»æ¨é€çš„ tag ä¸­è·å–ç‰ˆæœ¬å·
          $version = "$env:GITHUB_REF_NAME"
          echo "version=$version" >> $env:GITHUB_OUTPUT

      - name: Generate Changelog
        id: changelog
        shell: pwsh
        run: |
          # è·å–å½“å‰ç‰ˆæœ¬å·
          $currentTag = "$env:GITHUB_REF_NAME"

          # è·å–ä¸Šä¸€ä¸ªæ ‡ç­¾ï¼ˆæ’é™¤å½“å‰æ ‡ç­¾ï¼‰
          $previousTag = $(git describe --tags --abbrev=0 HEAD^ 2>$null)

          # ç”Ÿæˆ changelog å¤´éƒ¨
          $changelog = "## ğŸ‰ $currentTag`n`n"

          if ($previousTag) {
            # å¦‚æœå­˜åœ¨ä¸Šä¸€ä¸ªæ ‡ç­¾ï¼Œè·å–ä¸¤ä¸ªæ ‡ç­¾ä¹‹é—´çš„æäº¤
            $changelog += "### ğŸ“ è‡ª $previousTag ä»¥æ¥çš„æ›´æ”¹ï¼š`n`n"
            $commits = git log $previousTag..$currentTag --pretty=format:"- %s" --no-merges
          } else {
            # å¦‚æœä¸å­˜åœ¨ä¸Šä¸€ä¸ªæ ‡ç­¾ï¼ˆé¦–æ¬¡å‘å¸ƒï¼‰ï¼Œè·å–æœ€è¿‘ 20 æ¡æäº¤
            $changelog += "### ğŸ“ é¦–æ¬¡å‘å¸ƒï¼ˆæœ€è¿‘ 20 æ¡æäº¤ï¼‰ï¼š`n`n"
            $commits = git log --pretty=format:"- %s" --no-merges -n 20
          }

          # æ·»åŠ æäº¤åˆ—è¡¨
          $changelog += $commits

          # å°† changelog å†™å…¥æ–‡ä»¶
          $changelog | Out-File -Encoding UTF8 -FilePath changelog.txt

          # è¾“å‡º changelog å†…å®¹
          Get-Content changelog.txt

      - name: Publish Native AOT
        # å°†å‘½ä»¤åˆå¹¶ä¸ºä¸€è¡Œï¼Œé¿å… PowerShell æ¢è¡Œç¬¦é”™è¯¯
        run: dotnet publish ./RimTransAI/RimTransAI.csproj -c Release -r win-x64 --self-contained true -p:PublishAot=true -p:PublishSingleFile=true -p:IncludeNativeLibrariesForSelfExtract=true -p:TrimMode=partial -p:StripSymbols=true -p:DebugType=None -p:DebugSymbols=false -o ./publish

      - name: Compress for Release
        run: |
          cd ./publish
          # å†æ¬¡æ¸…ç†å¯èƒ½æ®‹ç•™çš„ PDB
          Get-ChildItem -Filter *.pdb | Remove-Item -Force -ErrorAction SilentlyContinue
          # æ‰“åŒ…æ‰€æœ‰æ–‡ä»¶
          Compress-Archive -Path * -DestinationPath ../RimTransAI-Win64.zip

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: RimTransAI-Artifact
          path: ./publish/*
          retention-days: 5

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: RimTransAI-Win64.zip
          draft: false
          prerelease: false
          body_path: changelog.txt
          name: RimTransAI ${{ steps.version.outputs.version }}
          generate_release_notes: false
          token: ${{ secrets.GITHUB_TOKEN }}
